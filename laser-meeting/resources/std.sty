% Needed for Tex 2019, which is not what arxiv or Ubuntu LTS use.
\newif\iflatesttex\latesttexfalse

\usepackage{listings}
\usepackage{subcaption}
\usepackage{tikz}
\usepackage{color, colortbl}
\usepackage{graphicx}
\usepackage{skull}

\definecolor{Gray}{gray}{0.9}

\usepackage{xcolor}
% red colored text
\colorlet{saved}{.}
\newcommand{\todo}[1]{\color[rgb]{1,0,0} #1 \color{saved}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% The ability to highlight individual lines in listings.                       %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% https://tex.stackexchange.com/questions/451532/recent-issues-with-lstlinebgrd-package-with-listings-after-the-latters-updates

\iflatesttex
\makeatletter
\let\old@lstKV@SwitchCases\lstKV@SwitchCases
\def\lstKV@SwitchCases#1#2#3{}
\makeatother
\usepackage{lstlinebgrd}
\makeatletter
\let\lstKV@SwitchCases\old@lstKV@SwitchCases

\lst@Key{numbers}{none}{%
    \def\lst@PlaceNumber{\lst@linebgrd}%
    \lstKV@SwitchCases{#1}%
    {none:\\%
     left:\def\lst@PlaceNumber{\llap{\normalfont
                \lst@numberstyle{\thelstnumber}\kern\lst@numbersep}\lst@linebgrd}\\%
     right:\def\lst@PlaceNumber{\rlap{\normalfont
                \kern\linewidth \kern\lst@numbersep
                \lst@numberstyle{\thelstnumber}}\lst@linebgrd}%
    }{\PackageError{Listings}{Numbers #1 unknown}\@ehc}}
\makeatother
\else
\usepackage{lstlinebgrd}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Code formatting.                                                             %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\lstdefinelanguage{rust}{
  sensitive=false,
  morekeywords={},
  keywordstyle=\ttfamily\bfseries,
  identifierstyle=\ttfamily,
  comment=[l]{//},
  commentstyle=\ttfamily,
  string=[d]{"},
  stringstyle=\ttfamily,
  mathescape=false,
  escapechar=\@,
  extendedchars=true,
  basicstyle=\footnotesize\ttfamily,
  showstringspaces=false,
  numbers=none,
  firstnumber=0,
  numberstyle=\small,
  stepnumber=5,
  numbersep=5pt,
  upquote=true,
  columns=fixed,
  flexiblecolumns=true}

\lstdefinelanguage{JavaScript}{
  sensitive=false,
  morekeywords={},
  keywordstyle=\ttfamily,
  identifierstyle=\ttfamily,
  comment=[l]{//},
  commentstyle=\ttfamily,
  string=[d]{"},
  stringstyle=\ttfamily,
  mathescape=false,
  escapechar=\#,
  extendedchars=true,
  literate={UNK}{{\tUnk}}1,
  basicstyle=\footnotesize\ttfamily,
  showstringspaces=false,
  numbers=none,
  firstnumber=0,
  numberstyle=\small,
  stepnumber=5,
  numbersep=5pt,
  upquote=true,
  columns=fixed,
  flexiblecolumns=true}

\lstset{language=JavaScript}

\newcommand{\dollar}{\mbox{\textdollar}}

\newcommand{\tUnk}{\ensuremath{\skull}}

% JS Keywords
\newcommand{\tKw}[1]{\text{\texttt{\textbf{#1}}}}
\newcommand{\tOp}[1]{\text{\texttt{#1}}}
\newcommand{\tId}[1]{\text{\texttt{\textsf{#1}}}}


% https://github.com/plasma-umass/arjun-papers/blob/6213a3d6ff8d715848a4c3b3220579b53c11903e/jsBots/pervasives.sty#L80
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Automatically use smaller fonts in figures.                                  %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\lstdefinestyle{figurestyle}{
  basicstyle=\fontsize{8}{7}\ttfamily,
  numbers=left,
  numberstyle=\fontsize{5}{5}\rmfamily,
  numbersep=0.4em,
  stepnumber=1,
  firstnumber=1,
  xleftmargin=1em,
  moredelim=**[is][\color[rgb]{1,0,0}]{@}{@}}

\lstdefinestyle{normalstyle}{
  basicstyle=\small\ttfamily,
  numbers=none,
  moredelim=**[is][\color[rgb]{1,0,0}]{@}{@}}

\newtoggle{infig}
\togglefalse{infig}
\AtBeginEnvironment{figure}{\toggletrue{infig}}
\AtEndEnvironment{figure}{\togglefalse{infig}}
\AtBeginEnvironment{figure*}{\toggletrue{infig}}
\AtEndEnvironment{figure*}{\togglefalse{infig}}
\AtBeginEnvironment{wrapfig}{\toggletrue{infig}}
\AtEndEnvironment{wrapfig}{\togglefalse{infig}}

\AtBeginEnvironment{lstlisting}{
  \iftoggle{infig}{
    \lstset{style=figurestyle}
  }{
    \lstset{style=normalstyle}}}

\pretocmd{\lstinputlisting}{
  \iftoggle{infig}{
    \lstset{style=figurestyle}
  }{
    \lstset{style=normalstyle}}}{}{}
